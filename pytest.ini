[pytest]
# -------------------------------------------------------------------
# Pytest Configuration for GPU/CPU Benchmark & Allure Reporting (Linux CI)
# -------------------------------------------------------------------
pythonpath = .
minversion = 8.0
timeout = 180
timeout_method = thread
timeout_func_only = true

# Directories where tests are located
testpaths = tests

# Recognize test file names
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# -------------------------------------------------------------------
# Logical grouping via markers
# -------------------------------------------------------------------
markers =
    gpu: GPU-related tests (generic CUDA/ROCm/Intel)
    cpu: CPU-bound tests
    nvidia: NVIDIA-specific tests (e.g., Tensor Core benchmarks)
    amd: AMD-specific tests (e.g., Matrix Core benchmarks)
    intel: Intel GPU or CPU-specific tests
    benchmark: Performance benchmarking
    stress: Heavy-load or endurance tests
    preprocess: Data preprocessing tasks
    accelerator: GPU accelerator tasks
    io_accelerator: I/O accelerator performance tests
    network_io_accelerator: Network I/O accelerator performance tests

# -------------------------------------------------------------------
# Allure + Benchmark + Logging Options
# -------------------------------------------------------------------
addopts =
    --tb=short
    --alluredir=allure-results
    --benchmark-json=allure-results/benchmark.json
    --benchmark-save=latest
    --benchmark-autosave
    --benchmark-min-rounds=5
    --disable-warnings
    -v
    -ra -q
    --maxfail=3
    --durations=10

# -------------------------------------------------------------------
# Resource Isolation & Reliability
# -------------------------------------------------------------------
# Prevent hangs by limiting concurrency and flushing GPU cache
# (See tests cleanup fixtures for gc + torch.cuda.empty_cache)
asyncio_mode = auto
norecursedirs = .* build dist venv .venv .cache

# Run tests in deterministic order for consistent benchmarking
faulthandler_timeout = 60

# -------------------------------------------------------------------
# Ignore specific warnings
# -------------------------------------------------------------------
filterwarnings =
    ignore::DeprecationWarning
    ignore::UserWarning
    ignore::RuntimeWarning
    ignore::FutureWarning

# -------------------------------------------------------------------
# Environment setup for CI runs
# -------------------------------------------------------------------
env =
    PYTHONUNBUFFERED=1
    PYTEST_DISABLE_PLUGIN_AUTOLOAD=1
    MPLCONFIGDIR=/tmp/matplotlib-cache
    NUMEXPR_MAX_THREADS=8
    OMP_NUM_THREADS=8
    CUDA_VISIBLE_DEVICES=0

# -------------------------------------------------------------------
# Notes:
# - Designed for Linux-based CI runners with Allure reports.
# - Ensures stability for combined GPU + I/O benchmark suites.
# - Avoids hangs seen when test modules share unflushed GPU/CPU memory.
# -------------------------------------------------------------------
