name: GPU Benchmark CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read     
  pages: write       
  id-token: write    

env:
  ALLURE_VERSION: 2.29.0
  RESULTS_DIR: allure-results
  SITE_DIR: allure-report

jobs:
  test:
    name: Run Pytest Benchmarks (Linux)
    runs-on: ubuntu-latest
    
    outputs:
      test_outcome: ${{ steps.run_tests.outputs.test_outcome }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          
      - name: Configure Python Path and Install Dependencies
        run: |
          # Inject the current working directory (repo root) into PYTHONPATH
          echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
          
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Allure Results Directory
        run: mkdir -p ${{ env.RESULTS_DIR }}

      - name: Create Allure Support Files
        run: |
          cp supports/environments.properties ${{ env.RESULTS_DIR }}/environments.properties
          echo '[]' > ${{ env.RESULTS_DIR }}/categories.json
          echo "{\"name\":\"GitHub Actions\",\"type\":\"GitHub\",\"url\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",\"buildName\":\"#${{ github.run_number }}.${{ github.run_attempt }}\",\"buildUrl\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" > ${{ env.RESULTS_DIR }}/executor.json
      
      - name: Run Pytest Benchmarks
        id: run_tests
        run: |
          python -m pytest -v -m gpu --alluredir="${{ env.RESULTS_DIR }}"
          PYTEST_EXIT_CODE=$?
          
          if [ $PYTEST_EXIT_CODE -eq 0 ]; then
            OUTCOME="PASS"
          elif [ $PYTEST_EXIT_CODE -eq 1 ]; then
            OUTCOME="UNSTABLE"
          else
            OUTCOME="FAIL"
          fi
          
          echo "Test exit code: $PYTEST_EXIT_CODE. Outcome: $OUTCOME"
          echo "test_outcome=$OUTCOME" >> "$GITHUB_OUTPUT"
          
        shell: bash
        continue-on-error: true

      - name: Upload Raw Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: allure-raw-results
          path: ${{ env.RESULTS_DIR }}

  # ----------------------------------------------------
  # Report Generation and Deployment Job
  # ----------------------------------------------------
  report:
    name: Generate & Deploy Allure Report
    needs: test
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Raw Allure Results
        uses: actions/download-artifact@v4
        with:
          name: allure-raw-results
          path: ${{ env.RESULTS_DIR }}
          
      # â¬…ï¸ FIX APPLIED HERE: Set continue-on-error: true
      - name: Download Previous Allure History
        uses: actions/download-artifact@v4
        with:
          name: allure-history
          path: previous_history
        continue-on-error: true # â¬…ï¸ Allow this step to fail if the artifact is missing or expired
          
      - name: Install Allure CLI & Generate Report
        run: |
          # Install Allure CLI
          wget https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/${{ env.ALLURE_VERSION }}/allure-commandline-${{ env.ALLURE_VERSION }}.zip -O allure.zip
          unzip allure.zip
          ALLURE_BIN=allure-commandline-${{ env.ALLURE_VERSION }}/bin/allure

          # Copy history files if the download succeeded
          if [ -d "previous_history/allure-history/history" ]; then
            mkdir -p ${{ env.RESULTS_DIR }}/history
            # Copy all files from the previous history into the new results
            # Note: The download action puts the artifact content inside a folder named after the artifact.
            cp -r previous_history/allure-history/history/* ${{ env.RESULTS_DIR }}/history/ || true
            echo "Copied previous history for trends."
          # Handle the case where the artifact download succeeded but the content was flat (less common with v4)
          elif [ -d "previous_history/history" ]; then
            mkdir -p ${{ env.RESULTS_DIR }}/history
            cp -r previous_history/history/* ${{ env.RESULTS_DIR }}/history/ || true
            echo "Copied previous history for trends (flat structure)."
          else
            echo "No previous Allure history found. Generating report without history trends."
          fi
          
          # Generate report
          $ALLURE_BIN generate ${{ env.RESULTS_DIR }} --clean -o ${{ env.SITE_DIR }}

      - name: Upload Allure History for Next Run
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: ${{ env.SITE_DIR }}/history
          retention-days: 7
          
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.SITE_DIR }}

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Add Workflow Summary (Status Badges)
        run: |
          TEST_STATUS=${{ needs.test.outputs.test_outcome }}
          PAGE_URL=${{ steps.deployment.outputs.page_url }}

          if [[ "$TEST_STATUS" == "FAIL" ]]; then
            STATUS_ICON="âŒ"
            STATUS_TEXT="Fail (Setup/Config Error)"
          elif [[ "$TEST_STATUS" == "UNSTABLE" ]]; then
            STATUS_ICON="âš ï¸"
            STATUS_TEXT="Unstable (Test(s) Failed)"
          else
            STATUS_ICON="âœ…"
            STATUS_TEXT="Pass (All Tests Succeeded)"
          fi

          echo "### ðŸ¤– GPU Benchmark CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "Status: **$STATUS_ICON $STATUS_TEXT**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Report]($PAGE_URL/index.html)" >> $GITHUB_STEP_SUMMARY
        shell: bash