name: GPU Benchmark

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pages: write
  id-token: write

env:
  ALLURE_VERSION: 2.29.0
  SITE_DIR: site

jobs:
  test:
    name: Run tests on Linux
    runs-on: ubuntu-latest
    outputs:
      test_outcome: ${{ steps.run_tests.outputs.test_outcome }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: gpu-benchmark:ci-build
          load: true

      - name: Run tests
        id: run_tests
        shell: bash
        run: |
          set +e
          RESULTS_DIR="allure-results/linux"
          mkdir -p "$RESULTS_DIR"
          docker run --rm -v $PWD:/workspace -w /workspace robotics-tdd:ci-build \
            pytest -v -m gpu --alluredir="$RESULTS_DIR"
          TEST_EXIT_CODE=$?

          if [ ! -d "$RESULTS_DIR" ] || [ -z "$(find $RESULTS_DIR -type f -name '*.json' 2>/dev/null)" ]; then
            echo "❌ No Allure results found — setup or configuration failure."
            echo "test_outcome=FAIL" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "⚠️ Some tests failed (pytest exit code $TEST_EXIT_CODE)."
            echo "test_outcome=UNSTABLE" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "✅ All tests passed successfully."
            echo "test_outcome=PASS" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Upload Allure Results Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-linux
          path: allure-results/linux

  report:
    name: Generate Allure Reports & Deploy
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download previous Allure history artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          branch: main
          name: allure-history
          path: previous-site
          if_no_artifact_found: ignore

      - name: Restore Allure History
        run: |
          mkdir -p "${{ env.SITE_DIR }}"
          if [ -d "previous-site" ]; then
            cp -r previous-site/* "${{ env.SITE_DIR }}/" || true
          fi

      - name: Download Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/${{ env.ALLURE_VERSION }}/allure-${{ env.ALLURE_VERSION }}.tgz
          tar -xzf allure-${{ env.ALLURE_VERSION }}.tgz
          mv allure-${{ env.ALLURE_VERSION }} allure-commandline
          echo "$(pwd)/allure-commandline/bin" >> $GITHUB_PATH

      - name: Download Allure Test Results
        uses: actions/download-artifact@v4
        with:
          path: allure-results

      - name: Generate Allure Report
        shell: bash
        run: |
          SITE_DIR="site"
          BUILD_NUMBER=${{ github.run_number }}
          RESULTS_DIR="allure-results/allure-results-linux"
          REPORT_DIR_BUILD="$SITE_DIR/$BUILD_NUMBER/linux"
          REPORT_DIR_LATEST="$SITE_DIR/latest/linux"
          mkdir -p "$RESULTS_DIR" "$REPORT_DIR_BUILD" "$REPORT_DIR_LATEST"

          cp supports/linux.properties "$RESULTS_DIR/environment.properties" 2>/dev/null || true
          cp supports/categories.json "$RESULTS_DIR/categories.json" 2>/dev/null || true

          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          echo "{\"name\":\"linux\",\"type\":\"GitHub Actions\",\"url\":\"${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\",\"reportUrl\":\"https://${GITHUB_REPOSITORY_OWNER}.github.io/${REPO_NAME}/latest/linux/\",\"buildOrder\":\"${BUILD_NUMBER}\",\"buildName\":\"Build ${BUILD_NUMBER} (linux)\",\"buildUrl\":\"${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\"}" > "$RESULTS_DIR/executor.json"

          allure generate "$RESULTS_DIR" -o "$REPORT_DIR_BUILD" --clean
          cp -r "$REPORT_DIR_BUILD"/* "$REPORT_DIR_LATEST/" || true
          date -u > "$REPORT_DIR_BUILD/build-info.txt"
          date -u > "$REPORT_DIR_LATEST/build-info.txt"

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.SITE_DIR }}

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Upload Allure History Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: ${{ env.SITE_DIR }}
          retention-days: 7