# ci.yml
name: GPU Benchmark

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

env:
  ALLURE_VERSION: 2.29.0
  SITE_DIR: site
  RESULTS_DIR: allure-results  # Define RESULTS_DIR globally for use in steps

jobs:
  test:
    name: Run tests on Ubuntu
    runs-on: ubuntu-latest  # â¬…ï¸ Removed 'windows-latest' from matrix
    strategy:
      fail-fast: false
      matrix:
        # â¬…ï¸ Removed matrix.os definition
        # os: [ubuntu-latest, windows-latest]
        # We now run only on a single, fixed OS (ubuntu-latest)

    outputs:
      test_outcome: ${{ steps.run_tests.outputs.test_outcome }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.10

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Allure Results Directory
        run: mkdir -p ${{ env.RESULTS_DIR }}

      - name: Copy Allure Environment Properties
        run: cp supports/environments.properties ${{ env.RESULTS_DIR }}/environments.properties # â¬…ï¸ ADDED: Copy environments.properties

      - name: Run Pytest Benchmarks
        id: run_tests
        run: |
          # â¬…ï¸ MODIFIED: Run only the 'gpu' mark tests and capture output for status
          if python -m pytest -v -m gpu --alluredir="${{ env.RESULTS_DIR }}" ; then
            echo "test_outcome=SUCCESS" >> "$GITHUB_OUTPUT"
          else
            # Check for test failures (exit code 1) or other errors (exit code 2/3)
            # We set UNSTABLE for test failures, and FAIL for config/setup errors, but here we simplify
            echo "test_outcome=UNSTABLE" >> "$GITHUB_OUTPUT"
          fi
        shell: bash
        
      # â¬…ï¸ REMOVED: Build Docker Image step

      - name: Get Build Number for Allure
        id: get_build_number
        run: |
          BUILD_NUMBER=${{ github.run_number }}-${{ github.run_attempt }}
          echo "build_number=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Generate Allure Report
        run: |
          # Download Allure Report Generator
          wget https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/${{ env.ALLURE_VERSION }}/allure-commandline-${{ env.ALLURE_VERSION }}.zip -O allure.zip
          unzip allure.zip
          
          # Copy previous history for trends and dashboard
          cp -r ${{ env.SITE_DIR }}/latest/ubuntu-latest/history ${{ env.RESULTS_DIR }}/ || true
          
          # Generate report including history, trends, categories, and executor.json
          ./allure-${{ env.ALLURE_VERSION }}/bin/allure generate ${{ env.RESULTS_DIR }} --clean -o ${{ env.SITE_DIR }}/latest/ubuntu-latest

      - name: Upload Allure History for Next Run
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: ${{ env.SITE_DIR }}
          retention-days: 7

      - name: Add Workflow Summary (Badges)
        run: |
          # Simplified summary since we only have one run now
          STATUS_TEXT=${{ steps.run_tests.outputs.test_outcome }}
          
          echo "### ðŸ¤– GPU Benchmark CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "Status: **$STATUS_TEXT**" >> $GITHUB_STEP_SUMMARY
        shell: bash
        
      - name: Deploy to GitHub Pages
        if: success() || failure()
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.SITE_DIR }}
          
      - name: Deploy
        id: deployment
        if: success() || failure()
        uses: actions/deploy-pages@v4